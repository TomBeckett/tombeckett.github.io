[{"content":"Anyone who has been on Hacker News or Reddit long enough knows the meta joke - skip the source and go straight to the comments.\nIt gives both site\u0026rsquo;s an air of group think that the content is always the site itself, so why bother reading the linked source? If it\u0026rsquo;s really good, it will be quoted or just pasted in a top comment anyway..?\nWhile an infinite amount of apes typing in /r/Superstonk, can create Shakespeare, often it just recreates the same thread over and over again.\nA posts lifecycle Getting points on Reddit or Hacker News is fairly easy but you\u0026rsquo;ll want to act quickly, so skim the post title, find the technology and post a familiar but easily disputed talking point:\n \u0026ldquo;Java? isn\u0026rsquo;t that an old slow language?\u0026quot; \u0026ldquo;PHP is always insecure, I don\u0026rsquo;t know why people use it!\u0026quot; \u0026ldquo;Node\u0026rsquo;s ecosystem is dangerous..\u0026quot; \u0026ldquo;Why didn\u0026rsquo;t they use TypeScript?/Go/Rust??\u0026quot;  After enough random comments to move the post from the new, more people will show up and dispute these claims. Don\u0026rsquo;t worry, they wont need to read the article either.\n \u0026ldquo;Wait, until you hear about how many sites run Wordpress..\u0026quot; \u0026ldquo;Have you heard about Laravel? it\u0026rsquo;s actually okay for PHP\u0026rdquo; \u0026ldquo;Try Deno/Yarn/nvm, it\u0026rsquo;s much better than npm\u0026rdquo; *\u0026ldquo;Go/Rust is a fad\u0026rdquo; \u0026ldquo;I don\u0026rsquo;t understand why we need TypeScript, JavaScript is fine\u0026rdquo;  The reaction to the reaction Eventually discussions of discussions will occur. Why PHP is so popular, do you need to learn a new language at all, the mandatory link to a relevant xkcd, TypeScript is good actually, webpack is an abomination and needs to be destroyed etc.\nI find these discussions extremely predicable and it\u0026rsquo;s not just me.\nMeta threads on both sites lament how despite having strong countercultures with strict rules against reposts, it\u0026rsquo;s hard to find new content.\nI depute this. It\u0026rsquo;s not the content, it\u0026rsquo;s the top user comments that are reposts.\nIt\u0026rsquo;s not just the readers who miss out While the linked source is probably happy they get any traffic, we\u0026rsquo;re training authors to write good titles and use A.I. to write the article.\nThey aren\u0026rsquo;t stupid and this game has become well established at this point. Want good traffic, make good title, skip the article body.\nWhy it happens I believe this all happens because both in source and in comments, people want to be noticed and heard, regardless of what originality.\nIt\u0026rsquo;s almost a weird internet nostalgia ritual - you say x, I say y back. I don\u0026rsquo;t think it\u0026rsquo;s inherently harmful as long as we acknowledge what\u0026rsquo;s happening.\nYou might learn something great in a comments section, but often you wasted some time in your day. It\u0026rsquo;s internet comfort food and thats okay. So lets stop pretending it\u0026rsquo;s all Shakespeare.\n","permalink":"https://tombeckett.github.io/posts/skip-source-read-comments/","summary":"Anyone who has been on Hacker News or Reddit long enough knows the meta joke - skip the source and go straight to the comments.\nIt gives both site\u0026rsquo;s an air of group think that the content is always the site itself, so why bother reading the linked source? If it\u0026rsquo;s really good, it will be quoted or just pasted in a top comment anyway..?\nWhile an infinite amount of apes typing in /r/Superstonk, can create Shakespeare, often it just recreates the same thread over and over again.","title":"Skip the source, straight to the comments"},{"content":"When working on the Squaddy App I\u0026rsquo;ve seen a LOT of internet background noise in our logs. It\u0026rsquo;s especially timely given the recent Log4j2 Remote Code Execution exploit.\nWe\u0026rsquo;ve done a lot of work to ensure we stay as safe as possible and I wanted to go through some recommendations.\nWhat we mean by \u0026lsquo;Safe\u0026rsquo;? Whenever talking about security we\u0026rsquo;re really asking \u0026ldquo;How confident am I this will work as I expect?\u0026quot;. No system is entirely secure and all security is ultimately based upon trust. Even in a zero trust security model, someone, somewhere, has to be trusted.\nUltimately it\u0026rsquo;s a business decision where and who is burdened with that trust.\nTo give a concrete example, we assume that all JSON Web Tokens are valid using Firebase Authentication SDK. For us, Firebase is our golden key and we believe that to be a small (and acceptable) amount of risk.\n Its important before doing any security hardening to know what needs to be secured and what are deemed as acceptable risks.\n Our aims should be:\n Minimize the attack surface. Secure all secrets in a vault. No one should know production passwords. Sanitize all user inputs. Redact sensitive information from logging. Add automated tooling to prevent security flaws before they are merged.  Minimize the attack surface Rather than providing lots of information thats already out there, I recommend:\n Enable Tomcat HTTPS or at least, have HTTPS for all services hitting your ingress. Use a Content Security Policy (CSP) for Cross Site Scripting (XSS) protection. Configure a Cross Site Request Forgery (CSRF) policy. This may include disabling it if using only REST. Test your response headers and remove any that give away more than they should (server type, allowed methods, etc). Use a Web Application Firewall (WAF) to block traffic your services should not serve, e.g. countries you don\u0026rsquo;t operate in or requests missing a JWT Authorization header.  Also, if your application is only available via REST, I recommend adding a default IndexController to serve browser traffic which is typically automated crawler/bots.\n/** * This controller is used to handle the case where the application is accessed via a browser. * \u0026lt;/p\u0026gt; * We want to return unauthorized to any request to prevent bots and crawlers from accessing the API. */ @Hidden //Hide from Swagger @RestController public class IndexController implements ErrorController { private static final Logger LOGGER = LoggerFactory.getLogger(IndexController.class); @RequestMapping(value = \u0026#34;/\u0026#34;) public ResponseEntity\u0026lt;Void\u0026gt; index() { return ResponseEntity.status(HttpStatus.UNAUTHORIZED).build(); } @RequestMapping(value = \u0026#34;/error\u0026#34;) public ResponseEntity\u0026lt;Void\u0026gt; error() { return ResponseEntity.status(HttpStatus.UNAUTHORIZED).build(); } @RequestMapping(value = \u0026#34;/robots.txt\u0026#34;) public void robots(final HttpServletRequest request, final HttpServletResponse response) { try { response.getWriter().write(\u0026#34;User-agent: *\\nDisallow: /\\n\u0026#34;); } catch (final IOException e) { LOGGER.error(SecurityMarkers.EVENT_FAILURE, \u0026#34;Failed to write robots.txt\u0026#34;, e); } } } The above will return 401 for any default or error pages and also return a disallow * for any robots.txt. This should help reduce the amount of crawler traffic.\nChoose a minimal runtime A primary concern is trusting that the runtime on our laptops is identical to production. Ensuring deployed dependencies - and therefore attack surface - is as small as possible.\nA key mitigation strategy is to create a Twelve-Factor App that can be securely tested and deployed by taking the same artifact through each environment. By only changing a few settings, it limits the amount of change and prevents unforeseen drift which leads to vulnerabilities.\nDocker has proven to be a good way to bundle an application and using Spring Profiles you can ensure the application can be configured in predictable ways.\n In a future post we\u0026rsquo;ll deep dive how to configure automated docker deployments to AWS Fargate using GitHub Actions.\n Configuring Maven Docker While it is possible to manually create a Dockerfile, I\u0026rsquo;ve found this produces surprisingly large images. It also creates another technology to learn and maintain security updates for.\nWe want a technology that always keeps up to date on every build and can produce a jar with only the required libraries. Luckily, Buildpack can do this for us using a Maven Plugin.\nAdding the following to your pom.xml and running mvn package will produce a docker image.\n\u0026lt;plugin\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-maven-plugin\u0026lt;/artifactId\u0026gt; \u0026lt;configuration\u0026gt; \u0026lt;image\u0026gt; \u0026lt;name\u0026gt;${project.version}\u0026lt;/name\u0026gt; \u0026lt;env\u0026gt; \u0026lt;JAVA_TOOL_OPTIONS\u0026gt;-Xms2048m -Xmx2048m\u0026lt;/JAVA_TOOL_OPTIONS\u0026gt; \u0026lt;/env\u0026gt; \u0026lt;/image\u0026gt; \u0026lt;/configuration\u0026gt; \u0026lt;/plugin\u0026gt; Compared to a manual Dockerfile I\u0026rsquo;ve found this image to be much smaller and preconfigured with the correct Java flags.\n I\u0026rsquo;ve set the maximum allocation pool and initial memory size flags using JAVA_TOOL_OPTIONS. This is important as we want the to automatically set the correct heap size based on a proper memory size. I\u0026rsquo;ve found that the container does not quite understand its size when this is not set. YMMV.\n The buildpack used is the Bellsoft Liberica JDK. I would recommend also using the same JDK when developing locally to ensure consistency.\nInjecting environment variables You may be wondering, \u0026ldquo;How do we set things like database connections? They can\u0026rsquo;t be baked into the image right?\u0026quot;.\nFear not, when we deploy this image we can override any Spring environment variable we want for example, setting @Profile.\n\u0026lt;env name=\u0026#34;AWS_REGION\u0026#34; value=\u0026#34;eu-west-2\u0026#34; /\u0026gt; \u0026lt;env name=\u0026#34;spring.profiles.active\u0026#34; value=\u0026#34;prod\u0026#34; /\u0026gt; \u0026lt;env name=\u0026#34;app.squaddy.api.devMockUser.enabled\u0026#34; value=\u0026#34;false\u0026#34; /\u0026gt; \u0026lt;env name=\u0026#34;spring.datasource.username\u0026#34; value=\u0026#34;AUserName\u0026#34; /\u0026gt; \u0026lt;env name=\u0026#34;spring.datasource.password\u0026#34; value=\u0026#34;************\u0026#34; /\u0026gt; \u0026lt;env name=\u0026#34;spring.datasource.url\u0026#34; value=\u0026#34;jdbc:mysql://squaddy.******.eu-west-2.rds.amazonaws.com:3306/db\u0026#34; /\u0026gt; While our API has around fifty environment settings, the difference between local, integration and production environments are only the most essential ones - database connection, AWS account information, etc. This gives us good confidence that the code we tested and the code being deployed is the same.\nRunning production, locally Now we\u0026rsquo;re confident that integration and production are similar, we should be able to make the reverse true - our local like integration or production.\nI recommend setting up a configuration in IntelliJ that is identical to integration or production. That way, you can switch over quickly to connect to the real services to aid debugging.\n If you are developing locally, having mock services is fine, but always have a ripcord to switch back to real ones.\n Secure all secrets in a vault Having a web certificate auto renew or a password auto-rotate is truly one of the best things about cloud services. It\u0026rsquo;s absolutely something you should be using. However, one of the challenges of getting those secrets into the runtime in a performant way.\nCurrently there seems to be two ways of achieving this (on AWS):\n Having the secret pull during runtime. Injecting the secret into build or deployment. Injecting the secret as an environment variable during startup.  They both have pro\u0026rsquo;s and con\u0026rsquo;s and go back to risk appetite in the business.\nPull during runtime  Expand for Java example // Use this code snippet in your app. // If you need more information about configurations or implementing the sample code, visit the AWS docs: // https://docs.aws.amazon.com/sdk-for-java/v1/developer-guide/java-dg-samples.html#prerequisites  public static void getSecret() { String secretName = \u0026#34;arn:aws:secretsmanager:eu-west-2:260023781495:secret:/secret/squaddy_dev/mysql-TFDMIj\u0026#34;; Region region = Region.of(\u0026#34;eu-west-2\u0026#34;); // Create a Secrets Manager client  SecretsManagerClient client = SecretsManagerClient.builder() .region(region) .build(); // In this sample we only handle the specific exceptions for the \u0026#39;GetSecretValue\u0026#39; API.  // See https://docs.aws.amazon.com/secretsmanager/latest/apireference/API_GetSecretValue.html  // We rethrow the exception by default.  String secret, decodedBinarySecret; GetSecretValueRequest getSecretValueRequest = GetSecretValueRequest.builder() .secretId(secretName) .build(); GetSecretValueResponse getSecretValueResponse = null; try { getSecretValueResponse = client.getSecretValue(getSecretValueRequest); } catch (DecryptionFailureException e) { // Secrets Manager can\u0026#39;t decrypt the protected secret text using the provided KMS key.  // Deal with the exception here, and/or rethrow at your discretion.  throw e; } catch (InternalServiceErrorException e) { // An error occurred on the server side.  // Deal with the exception here, and/or rethrow at your discretion.  throw e; } catch (InvalidParameterException e) { // You provided an invalid value for a parameter.  // Deal with the exception here, and/or rethrow at your discretion.  throw e; } catch (InvalidRequestException e) { // You provided a parameter value that is not valid for the current state of the resource.  // Deal with the exception here, and/or rethrow at your discretion.  throw e; } catch (ResourceNotFoundException e) { // We can\u0026#39;t find the resource that you asked for.  // Deal with the exception here, and/or rethrow at your discretion.  throw e; } // Decrypts secret using the associated KMS key.  // Depending on whether the secret is a string or binary, one of these fields will be populated.  if (getSecretValueResponse.secretString() != null) { secret = getSecretValueResponse.secretString(); } else { decodedBinarySecret = new String(Base64.getDecoder().decode(getSecretValueResponse.secretBinary().asByteBuffer()).array()); } // Your code goes here. }   Personally I am not a fan of the first one (which AWS gives the example for). I don\u0026rsquo;t like having a surprise when the secret doesn\u0026rsquo;t get pulled in runtime. This could happen for a variety of reasons but configuration/permissions change or network issue both seem like reasonable risks. I like things to fail early, ideally in the build or deployment process.\nInject into build or deployment So why not always use injection? Well theres issues there too. Injecting a secret into the build is a no go as it breaks the Twelve-Factor App principle.\nInject as environment variable during startup Finally, we have injecting the secret as an environment variable. This is commonly seen in AWS provided examples using Lambda.\nIt\u0026rsquo;s possible (although not well documented) that you can use a ECS Task Definition to get secrets during startup:\n\u0026#34;secrets\u0026#34;: [ { \u0026#34;name\u0026#34;: \u0026#34;spring.datasource.password\u0026#34;, \u0026#34;valueFrom\u0026#34;: \u0026#34;arn:aws:secretsmanager:eu-west-2:12345:secret:/secret/squaddy/mysql-:12345::password::\u0026#34; }, ] This one I like the most as it keeps secrets separate and not \u0026lsquo;baked in\u0026rsquo;. The negatives are:\n If secrets rotation will cause errors if they rotate during the runtime. Other issues may also arise if the secret needs to change. The secrets are in plain text in the AWS Console.  Sanitize all user inputs A key strategy in defensive programming is not to trust anything another client or user gives you. This doesn\u0026rsquo;t just mean security, it also means \u0026lsquo;bad data\u0026rsquo;.\nEnsure you understand who your client is Your tolerance for what a \u0026lsquo;client\u0026rsquo; means can vary between teams and businesses. For example, in a microservice architecture, do you trust other services? What about third party webhooks? Does having a shared secret or SSL help?\nCommon sanitization techniques Here\u0026rsquo;s an example from the Squaddy API:\n@PostMapping(value = \u0026#34;/group/chat\u0026#34;) public ResponseEntity\u0026lt;UploadRequestResponseDTO\u0026gt; generateChatFileSignedUrl(@RequestParam(\u0026#34;mimeType\u0026#34;) @NotBlank(message = \u0026#34;MimeType must not be blank.\u0026#34;) final String mimeType, @RequestParam(\u0026#34;extension\u0026#34;) @NotBlank(message = \u0026#34;Extension must not be blank.\u0026#34;) final String extension, @RequestParam(\u0026#34;groupId\u0026#34;) @Min(value = 1L, message = \u0026#34;The value must be positive.\u0026#34;) final Long groupId) { final var safeMimeType = Encode.forJava(mimeType); final var safeExtension = Encode.forJava(extension); return new ResponseEntity\u0026lt;\u0026gt;( storageService.generateSignedUrl(safeMimeType.toLowerCase(Locale.ROOT), safeExtension.toUpperCase(Locale.ROOT), groupId.toString()), HttpStatus.CREATED ); } Firstly, I highly recommend using Spring Validation to check the inputs. For example @Min will reject any groupId less than 1.\nSecondly, know mimeType and extension will be present (as it must pass @NotBlank), we can\u0026rsquo;t be sure they are safe as they are strings. Common techniques to resolve this would be to trim whitespace or emoji\u0026rsquo;s from strings by running through regex to only allow numbers or alphanumeric. I am not a fan of this approach. Regex is famously complicated and I would recommend instead using the OWASP Java Encoder.\nFinally, you\u0026rsquo;ll note that we don\u0026rsquo;t do any sanitization on groupId. We know this to be a integer and (hopefully) fairly safe.\nThe key takeaways here are:\n A mix of validation and sanitization is required. No one approach is enough. Use a proper library over rolling your own regex or trimming. It\u0026rsquo;s cleaner and less prone to errors.  Redact sensitive information from logging One overlooked aspect to security is logging. When developing locally logging feels cheap but once deployed to production is hard to see the wood for the trees.\nThere are a few things to remember when it comes to security and logging:\nMask your logs Here is a quick introduction to adding owasp-security-logging and masking.\nAdd the following to your pom.xml:\n\u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.owasp\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;security-logging-logback\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;LATEST\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; Now make sure to update any LOGGER calls with a new SecurityMarker.\nLOGGER.info(\u0026#34;userid={}\u0026#34;, userid); LOGGER.info(SecurityMarkers.CONFIDENTIAL, \u0026#34;password={}\u0026#34;, password); This will later produce something similar to:\n2014-12-16 13:54:48,860 [main] INFO - userid=joebob 2014-12-16 13:54:48,860 [main] [CONFIDENTIAL] INFO - password=*********** As you can see, the second line as been redacted due to being CONFIDENTIAL.\nDon\u0026rsquo;t over log. Using Log Levels, owasp-security-logging and logstash-logback-encoder  a useful (but redacted) log can be produced.\nLOGGER.debug(SecurityMarkers.SECURITY_AUDIT, CHECKING_USER_MESSAGE, firebaseId); Will produce:\n{ \u0026#34;@timestamp\u0026#34;: \u0026#34;2021-12-28T14:42:54.118Z\u0026#34;, \u0026#34;@version\u0026#34;: \u0026#34;1\u0026#34;, \u0026#34;message\u0026#34;: \u0026#34;Checking user exists: **********************\u0026#34;, // Redacted  \u0026#34;logger_name\u0026#34;: \u0026#34;app.squaddy.api.persistence.UserPersistenceService\u0026#34;, \u0026#34;thread_name\u0026#34;: \u0026#34;http-nio-8080-exec-9\u0026#34;, \u0026#34;level\u0026#34;: \u0026#34;DEBUG\u0026#34;, \u0026#34;level_value\u0026#34;: 10000, \u0026#34;transaction.id\u0026#34;: \u0026#34;8b6f99ac-272e-4476-b29c-e0f75cc87bd0\u0026#34;, // A unique id for this request  \u0026#34;transaction.requestMethod\u0026#34;: \u0026#34;GET\u0026#34;, \u0026#34;transaction.requestUrl\u0026#34;: \u0026#34;/v2/user/groups/0\u0026#34;, \u0026#34;transaction.proxyRemoteIp\u0026#34;: \u0026#34;*****\u0026#34;, // Redacted  \u0026#34;transaction.firebaseId\u0026#34;: \u0026#34;**********************\u0026#34;, // Redacted  \u0026#34;transaction.host\u0026#34;: \u0026#34;api.squaddy.app\u0026#34;, \u0026#34;transaction.remoteIp\u0026#34;: \u0026#34;10.0.0.159\u0026#34;, \u0026#34;transaction.isPublicApi\u0026#34;: \u0026#34;false\u0026#34;, \u0026#34;transaction.userAgent\u0026#34;: \u0026#34;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/96.0.4664.110 Safari/537.36\u0026#34;, \u0026#34;tags\u0026#34;: [ \u0026#34;SECURITY AUDIT\u0026#34; // A security marker added  ] }  By using a security markers and using levels we can restrict the overhead of logging for each environment without altering code.\n Encode your logs Log Forging or Log Injection is one of the top OWASP vulnerabilities and not often talked about. The same owasp-security-logging library can also be configured add CRLF encoding to any logged text.\nFor example:\n\u0026lt;conversionRule conversionWord=\u0026#34;crlf\u0026#34; converterClass=\u0026#34;org.owasp.security.logging.mask.CRLFConverter\u0026#34; /\u0026gt; \u0026lt;layout class=\u0026#34;ch.qos.logback.classic.PatternLayout\u0026#34;\u0026gt; \u0026lt;Pattern\u0026gt;STDOUT %d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %crlf(%msg) %n \u0026lt;/Pattern\u0026gt; \u0026lt;/layout\u0026gt; I would also recommend switching to JSON in production over using standard console out as it\u0026rsquo;s a far more flexible (and searchable) format.\nAdd automated tooling to prevent security flaws before they are merged. A final piece in the puzzle is to introduce more automation. There are many options for static code analysis and as usual a mix (and configuration) is required to get a balanced view.\nAt Squaddy we use SonarQube\u0026rsquo;s hosted SonarCloud and Snyk. They both have excellent IntelliJ plugins and integrate well with GitHub Actions.\nAs mentioned no tool is perfect and SonarQube in particular can sometimes blur the lines between \u0026ldquo;we think this looks better\u0026rdquo;, \u0026ldquo;we believe this to be bad practice\u0026rdquo; and \u0026ldquo;this is a very bad security practice\u0026rdquo;. However on balance they are an absolute upgrade and even if after a bit of research I disagree, I am at least wiser for it.\nConclusion Thank you for reading and I hope this was useful. My intention was not to deep dive any one subject but more to provide thought on various aspects to security. There is no one size fits all and it doesn\u0026rsquo;t all need to happen in Sprint 0.\nUltimately security is an on-going and multi aspect concern. I\u0026rsquo;ve learnt over time that the better you understand your business needs, the easier it is to make security decisions.\n","permalink":"https://tombeckett.github.io/posts/spring-security-hardening/","summary":"When working on the Squaddy App I\u0026rsquo;ve seen a LOT of internet background noise in our logs. It\u0026rsquo;s especially timely given the recent Log4j2 Remote Code Execution exploit.\nWe\u0026rsquo;ve done a lot of work to ensure we stay as safe as possible and I wanted to go through some recommendations.\nWhat we mean by \u0026lsquo;Safe\u0026rsquo;? Whenever talking about security we\u0026rsquo;re really asking \u0026ldquo;How confident am I this will work as I expect?","title":"Spring Boot: Security Hardening"},{"content":"A common complaint about Spring refers to Spring Magic and general confusion about how dependency injection works in Spring. It can be extremely confusing to get a stacktrace like this:\nError creating bean with name \u0026#39;beanA\u0026#39;: Injection of autowired dependencies failed; nested exception is org.springframework.beans.factory.BeanCreationException: Could not autowire field: private com.example.demo.BeanB com.example.demo.BeanA.dependency; nested exception is org.springframework.beans.factory.NoSuchBeanDefinitionException: No qualifying bean of type [com.example.demo.BeanB] found for dependency: expected at least 1 bean which qualifies as autowire candidate for this dependency. Dependency annotations: {@org.springframework.beans.factory.annotation.Autowired(required=true)} The challenges of Inversion of Control Inversion of Control (IoC) is a way to create an object without expressly creating or managing its dependencies.\nTo explain why you may want IoC, I\u0026rsquo;m going to use a common onion architecture example seen in many REST services.\nvar config = { startOnLoad: true, theme: 'neutral', align: 'left' }; mermaid.initialize(config);  flowchart LR RestController -- BusinessService -- PersistenceService -.- Database[(Database)] RestController -- AnotherBusinessService -- PersistenceService  Lets say we want to make a new instance of a RestController:\npublic class RestController { final BusinessService businessService; final AnotherBusinessService anotherBusinessService; public RestController() { var persistenceService = new PersistenceService(\u0026#34;someDatabaseConnection?\u0026#34;); businessService = new BusinessService(persistenceService); anotherBusinessService = new AnotherBusinessService(persistenceService); } } Thats.. fairly messy. We can imagine that as BusinessService expands to need more of its own dependencies we\u0026rsquo;re quickly going to get into maintainability issues.\n Where would you instantiate a common singleton across many controllers? What happens if PersistenceService has more of its own dependencies? Suddenly your passing dependencies of dependencies down many layers. As your application gets larger, you can imagine needing logging classes, database connections, etc. Thats a lot of crud in your constructors. This constructor logic can pollute downstream classes, violating the Single Responsibility Principle. Managing your own dependencies can cause circular dependency issues.  To give another example, imagine a scenario where you wanted a certain Database in production (MySQL) but a memory database locally (H2). In this circumstance you would need to put a nasty if somewhere in your code, depending on the environment.\nIts not.. bad but its not nice either. Lets see what other options we have available to us.\nSo what is a bean? A Bean is a Spring concept for an object that are under dependency management by the Spring Framework. Spring uses its own IoC Container that does this heavy lifting for you.\nTo register a bean you need to let Spring know what it should be managing and how it should be managed. In our example BusinessService, AnotherBusinessService and PersistenceService all should be managed. To do that, we need to use an Annotation.\n@Service // Added Spring annotation public class RestController { } By adding the @Service annotation we\u0026rsquo;re telling Spring that this class is a Business Service Facade aka its a business logic class and will be reused.\nAfter adding that annotation to the other classes, we can refactor our RestController.\npublic class RestController { @Autowired // Added Spring annotation  final BusinessService businessService; @Autowired // Added Spring annotation  final AnotherBusinessService anotherBusinessService; // Constructor has been removed. } We\u0026rsquo;ve added @Autowired and removed the constructor. I hope you will agree that this is much cleaner and ultimately maintainable. But how does Autowired work?\nWhen the application starts, Spring looks for usages of @Autowired. Then it looks for any registered beans, in our case they have been registered using @Service. It will then consolidate all dependencies to reuse as many as possible during its runtime.\n There are other annotations that could be used (@Component or @Repository) but @Service seems to most appropriate in this use case.\nCorrect annotations can be a good source for documentation.\n I hope you agree that an Inversion of control framework can make code much more sustainable and ultimately more stable.\nAn alternative Some people do not like this style of injection as they feel using @Autowired too much like \u0026lsquo;magic\u0026rsquo; and not close enough to regular Java.\nI suspect this comes down to \u0026ldquo;Are you okay with Annotations in Java?\u0026quot;.\nWhile Spring is very annotation heavy, the Spring team is now offering (and even recommending) constructor injection. This is far closer to regular Java and other languages:\npublic class RestController { final BusinessService businessService; final AnotherBusinessService anotherBusinessService; public RestController(BusinessService businessService, AnotherBusinessService anotherBusinessService) { this.businessService = businessService; this.anotherBusinessService = anotherBusinessService; } } Effectively Spring just \u0026lsquo;knows\u0026rsquo; about what a BusinessService is from the @Service annotation. This keeps the RestController clean and understandable, it also gives us flexibility by still having a constructor.\nI personally do prefer this style as it removes two annotations and makes the code a bit easier to understand. We also have a constructor we can now use in our unit tests if required.\nWhen it goes wrong There are a few things to look out for when it comes to Spring IoC.\nDon\u0026rsquo;t use new Any attempts to create an object manually will mean Spring ignores that object and all its descendants. This may seem obvious but effectively when you annotate a class with @Service, @Component or @Repository you are handing over ownership to Spring IoC to create and manage that class. Using the new keyword may cause errors as the objects dependency tree wont be properly created.\nIts very much all or nothing when it comes to Spring IoC. In certain circumstances this may be fine (such as unit testing) but overall, it\u0026rsquo;s best to avoid creating objects yourself and letting Spring handle it.\nYou\u0026rsquo;ve added another class to a constructor Using our example from above, if you add another class to the constructor but do not annotate with @Service you will see an error:\npublic class RestController { final BusinessService businessService; final AnotherBusinessService anotherBusinessService; final NewService newService; public RestController(BusinessService businessService, AnotherBusinessService anotherBusinessService, NewService newService) { this.businessService = businessService; this.anotherBusinessService = anotherBusinessService; this.newService = newService; // new service without @Service annotation!  } } // No annotation public class NewService() {} NewService is not known\u0026hellip;\nError creating bean with name \u0026#39;NewService\u0026#39;: Injection of autowired dependencies failed; nested exception is org.springframework.beans.factory.BeanCreationException: Could not autowire field: private com.example.demo.NewService com.example.demo.NewService.dependency; nested exception is org.springframework.beans.factory.NoSuchBeanDefinitionException: No qualifying bean of type [com.example.demo.NewService] found for dependency: expected at least 1 bean which qualifies as autowire candidate for this dependency. Dependency annotations: {@org.springframework.beans.factory.annotation.Autowired(required=true)} In this situation adding @Service to NewService would register the class and allow Spring to manage this bean correctly.\n@Service // Annotation added. Bean should now be registered. public class NewService() {} The above error stacktrace is the same example from the introduction. I hope this makes feels more approachable now!\nUsing alternative services In this final example we want to vary which service we get depending on if we\u0026rsquo;re running locally or in production. This is exceptionally powerful.\nvar config = { startOnLoad: true, theme: 'neutral', align: 'left' }; mermaid.initialize(config);  flowchart LR RestController -- BusinessService -- LocalBusinessServiceImpl RestController -- BusinessService -- ProductionBusinessServiceImpl  First, we create a shared interface with each service having the @Service annotation.\npublic interface BusinessService { String getEnvironment(); } @Service public class LocalBusinessServiceImpl implements BusinessService { public String getEnvironment() { return \u0026#34;Local\u0026#34;; } } @Service public class ProductionBusinessServiceImpl implements BusinessService { public String getEnvironment() { return \u0026#34;Production\u0026#34;; } } public class RestController { final BusinessService businessService; public RestController(BusinessService businessService) { this.businessService = businessService; } } Now we have an issue if we start the application Spring will throw a stacktrace error similar to:\nDescription: Field businessService in com.example.demo.RestController required a single bean, but 2 were found: - businessService: defined by method \u0026#39;businessService\u0026#39; in class path resource [com/example/LocalBusinessServiceImpl.class] - businessService: defined by method \u0026#39;businessService\u0026#39; in class path resource [com/example/ProductionBusinessServiceImpl.class] Action: Consider marking one of the beans as @Primary, updating the consumer to accept multiple beans, or using @Qualifier to identify the bean that should be consumed Newcomers can get frustrated by the word bean and while the action appears clear, it does not help the programmer make a decision on where or why to add @Primary.\nWhats happening is Spring says \u0026ldquo;You have two possible candidates, which do you want to use?\u0026quot;. Remember that Spring IoC needs to know not only what but when to use a Bean.\nLets fix our code:\n// Interface and RestController unchanged.  @Profile(\u0026#34;dev\u0026#34;) // New annotation @Service public class LocalBusinessServiceImpl implements BusinessService { public String getEnvironment() { return \u0026#34;Local\u0026#34;; } } @Profile(\u0026#34;prod\u0026#34;) // New annotation @Service public class ProductionBusinessServiceImpl implements BusinessService { public String getEnvironment() { return \u0026#34;Production\u0026#34;; } } Here we\u0026rsquo;ve added a @Profile annotation to tell Spring when to use each bean.\nWe also could have also used one of the recommended actions from the previous stacktrace:\n// Interface, RestController unchanged.  @Service public class LocalBusinessServiceImpl implements BusinessService { public String getEnvironment() { return \u0026#34;Local\u0026#34;; } } @Profile(\u0026#34;!dev\u0026#34;) // If its not dev @Order(1) // Use this one first @Service public class ProductionBusinessServiceImpl implements BusinessService { public String getEnvironment() { return \u0026#34;Production\u0026#34;; } }  Remember, if you see a \u0026lsquo;bean\u0026rsquo; error its because Spring either has too many options or no options when configuring IoC.\n Conclusion I hope after this introduction to Spring you understand a bit more about:\n Why you should be using Spring\u0026rsquo;s inversion of control. How to configure a Spring Bean. Potential methods for resolving Spring bean stacktraces.  ","permalink":"https://tombeckett.github.io/posts/spring-magic/","summary":"A common complaint about Spring refers to Spring Magic and general confusion about how dependency injection works in Spring. It can be extremely confusing to get a stacktrace like this:\nError creating bean with name \u0026#39;beanA\u0026#39;: Injection of autowired dependencies failed; nested exception is org.springframework.beans.factory.BeanCreationException: Could not autowire field: private com.example.demo.BeanB com.example.demo.BeanA.dependency; nested exception is org.springframework.beans.factory.NoSuchBeanDefinitionException: No qualifying bean of type [com.example.demo.BeanB] found for dependency: expected at least 1 bean which qualifies as autowire candidate for this dependency.","title":"Spring Boot: Magic Beans"},{"content":"Five years ago I moved to Spring Boot from ASP.NET. Frankly, I found Java and the Spring Framework confusing and it was not my choice to use it.\nSince then I\u0026rsquo;ve used many other backend technologies (Ruby on Rails, ASP.NET Core, Express/TypeScript) but I keep coming back to Spring. I\u0026rsquo;ve really had a change of heart with Spring.\nOver those years I\u0026rsquo;ve had to teach many others about Spring and common questions come up:\n What exactly is Spring (and Spring Boot) Why is there so much \u0026lsquo;magic\u0026rsquo; (beans) going on? Isn\u0026rsquo;t Java a dead language?   To clarify, I\u0026rsquo;m not here to convince anyone that \u0026ldquo;Spring is awesome and suits every project\u0026rdquo;. But over the next few posts I do want to lower the bar for getting started.\n What is Spring? Here\u0026rsquo;s what the Spring docs have to say:\n Spring makes it easy to create Java enterprise applications. It provides everything you need to embrace the Java language in an enterprise environment, with support for Groovy and Kotlin as alternative languages on the JVM, and with the flexibility to create many kinds of architectures depending on an application’s needs.\n That\u0026rsquo;s fairly wordy but essentially its a framework for making enterprise applications. It can be further extended with Modules which are community driven. When people say \u0026ldquo;Spring\u0026rdquo; they refer to not just the Spring Framework but also to the modules built on top of it - the Spring stack or ecosystem.\nThis has the advantage of having many options but can also be very frustrating to newcomers.\nWhat does Spring mean by \u0026lsquo;Enterprise\u0026rsquo;? I\u0026rsquo;m not sure why Spring insists on name dropping enterprise as it can turn off many smaller developers and make the framework appear \u0026lsquo;heavy\u0026rsquo;.\nI would assert that many common enterprise problems are problems anyone faces when taking a project from their laptop to production:\n Support multiple deployment environments. In enterprise land this means not having direct access to production. Even if you do, you shouldn\u0026rsquo;t. Dependency injection and inversion of control. In the world of enterprise this can be different LDAP implementations, but even a local developer benefits by having a mock third party integration when running locally vs a real one in production. Transaction management. Many enterprises demand proper transactions around SQL updates, this is just good practice at any scale.  Who owns Spring? The framework is entirely Open Source and has an Apache 2.0 license. It is \u0026lsquo;free\u0026rsquo; as in beer.\nFrom an ownership perspective, the original founders' company - Spring (previously SpringSource) was brought by Pivitol Software which it self is now VMware Tanzu Labs.\nLooking at the contributors graph for Spring you\u0026rsquo;ll see VMware/Pivitol staff as the main core contributors.\n TLDR; Its open source but VMware owns the trademark.\n What is Spring Boot I hear people describe Spring Boot like this:\n Spring Boot is a bootstrap project (hence the name) maintained by the Spring team. It has sensible defaults already set and is designed to get going as quickly as possible.\n And I mostly agree. Its similar to Ruby on Rails or Create React App in that it gives you a stack to get going quickly.\nTypically people will use the Spring Initializr and choose additional dependencies such as Spring Web for a RESTful service with built in Apache Tomcat Server and Spring Security for authorization and authentication.\nThis is all nice, but in reality the biggest advantages when using Spring Boot is:\n All projects have a familiar structure. Common tasks (such as setting up logging, IoC, Maven, environment settings, etc) are setup saving time.  The second point is nice, but the first should be repeated:\n A common opinionated view way of working is a game changer when choosing a technology and forming a team.\n What Spring isn\u0026rsquo;t I would assert that a project (aka module) being in the Spring Framework is not any kind of seal of quality. Some projects are far more popular and well funded than others.\nIt\u0026rsquo;s not impossible for projects to leave the framework.\nRemember, it\u0026rsquo;s a collection of projects and modules. It\u0026rsquo;s down to experience to pick the ones right for you. Spring is only heavy if you want it to be.\n","permalink":"https://tombeckett.github.io/posts/spring-introduction/","summary":"Five years ago I moved to Spring Boot from ASP.NET. Frankly, I found Java and the Spring Framework confusing and it was not my choice to use it.\nSince then I\u0026rsquo;ve used many other backend technologies (Ruby on Rails, ASP.NET Core, Express/TypeScript) but I keep coming back to Spring. I\u0026rsquo;ve really had a change of heart with Spring.\nOver those years I\u0026rsquo;ve had to teach many others about Spring and common questions come up:","title":"Spring Boot: A quick introduction"},{"content":"I don\u0026rsquo;t really like blogging as a concept. My reaction is due to the tech world insisting every engineer should be blogging and how you should feel bad if you don\u0026rsquo;t. I\u0026rsquo;m a fairly private person with little to no online presence.\nDespite this I\u0026rsquo;ve wanted to blog for a few years. As a side effect, I\u0026rsquo;m pretty guilty for sending my friends walls of text about my diehard feelings on various tech topics. They reply suggesting I start a blog - I suspect as a coping mechanism.\nTheres a few reasons I feel apprehensive about blogging:\n I don\u0026rsquo;t feel like my writing skills are up to task. I\u0026rsquo;m not sure if my ideas are interesting enough for an entire lengthy post. It feels hipster and a bit look at me. I\u0026rsquo;m afraid that I\u0026rsquo;ll stop and people will see a blog thats clearly failed. Bloggers seems obsessed with making money.  For me it all comes down to motivation. I\u0026rsquo;ll blog only when I have something interesting to say. There wont be a regular schedule but when I do post I hope its interesting.\n","permalink":"https://tombeckett.github.io/posts/why-blog/","summary":"I don\u0026rsquo;t really like blogging as a concept. My reaction is due to the tech world insisting every engineer should be blogging and how you should feel bad if you don\u0026rsquo;t. I\u0026rsquo;m a fairly private person with little to no online presence.\nDespite this I\u0026rsquo;ve wanted to blog for a few years. As a side effect, I\u0026rsquo;m pretty guilty for sending my friends walls of text about my diehard feelings on various tech topics.","title":"Why blog? Why now?"}]