<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>Spring Boot: Security Hardening | Tom Beckett</title>
<meta name=keywords content="java,spring,spring-boot,security,spring-security">
<meta name=description content="When working on the Squaddy App I&rsquo;ve seen a LOT of internet background noise in our logs. It&rsquo;s especially timely given the recent Log4j2 Remote Code Execution exploit.
We&rsquo;ve done a lot of work to ensure we stay as safe as possible and I wanted to go through some recommendations.
What we mean by &lsquo;Safe&rsquo;? Whenever talking about security we&rsquo;re really asking &ldquo;How confident am I this will work as I expect?">
<meta name=author content="Tom Beckett">
<link rel=canonical href=https://tombeckett.github.io/posts/spring-security-hardening/>
<meta name=google-site-verification content="XYZabc">
<meta name=yandex-verification content="XYZabc">
<meta name=msvalidate.01 content="XYZabc">
<link crossorigin=anonymous href=/assets/css/stylesheet.min.612a587c75dbaa6349d632572927d1b3e50ae108eaa982ebbc7782882e385faf.css integrity="sha256-YSpYfHXbqmNJ1jJXKSfRs+UK4QjqqYLrvHeCiC44X68=" rel="preload stylesheet" as=style>
<link rel=icon href=https://tombeckett.github.io/%3Clink%20/%20abs%20url%3E>
<link rel=icon type=image/png sizes=16x16 href=https://tombeckett.github.io/%3Clink%20/%20abs%20url%3E>
<link rel=icon type=image/png sizes=32x32 href=https://tombeckett.github.io/%3Clink%20/%20abs%20url%3E>
<link rel=apple-touch-icon href=https://tombeckett.github.io/%3Clink%20/%20abs%20url%3E>
<link rel=mask-icon href=https://tombeckett.github.io/%3Clink%20/%20abs%20url%3E>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.92.0">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-123-45','auto'),ga('send','pageview'))</script><meta property="og:title" content="Spring Boot: Security Hardening">
<meta property="og:description" content="When working on the Squaddy App I&rsquo;ve seen a LOT of internet background noise in our logs. It&rsquo;s especially timely given the recent Log4j2 Remote Code Execution exploit.
We&rsquo;ve done a lot of work to ensure we stay as safe as possible and I wanted to go through some recommendations.
What we mean by &lsquo;Safe&rsquo;? Whenever talking about security we&rsquo;re really asking &ldquo;How confident am I this will work as I expect?">
<meta property="og:type" content="article">
<meta property="og:url" content="https://tombeckett.github.io/posts/spring-security-hardening/"><meta property="og:image" content="https://tombeckett.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-12-28T01:00:00+00:00">
<meta property="article:modified_time" content="2021-12-28T01:00:00+00:00"><meta property="og:site_name" content="Tom Beckett">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://tombeckett.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E">
<meta name=twitter:title content="Spring Boot: Security Hardening">
<meta name=twitter:description content="When working on the Squaddy App I&rsquo;ve seen a LOT of internet background noise in our logs. It&rsquo;s especially timely given the recent Log4j2 Remote Code Execution exploit.
We&rsquo;ve done a lot of work to ensure we stay as safe as possible and I wanted to go through some recommendations.
What we mean by &lsquo;Safe&rsquo;? Whenever talking about security we&rsquo;re really asking &ldquo;How confident am I this will work as I expect?">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://tombeckett.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Spring Boot: Security Hardening","item":"https://tombeckett.github.io/posts/spring-security-hardening/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Spring Boot: Security Hardening","name":"Spring Boot: Security Hardening","description":"When working on the Squaddy App I\u0026rsquo;ve seen a LOT of internet background noise in our logs. It\u0026rsquo;s especially timely given the recent Log4j2 Remote Code Execution exploit.\nWe\u0026rsquo;ve done a lot of work to ensure we stay as safe as possible and I wanted to go through some recommendations.\nWhat we mean by \u0026lsquo;Safe\u0026rsquo;? Whenever talking about security we\u0026rsquo;re really asking \u0026ldquo;How confident am I this will work as I expect?","keywords":["java","spring","spring-boot","security","spring-security"],"articleBody":"When working on the Squaddy App I’ve seen a LOT of internet background noise in our logs. It’s especially timely given the recent Log4j2 Remote Code Execution exploit.\nWe’ve done a lot of work to ensure we stay as safe as possible and I wanted to go through some recommendations.\nWhat we mean by ‘Safe’? Whenever talking about security we’re really asking “How confident am I this will work as I expect?\". No system is entirely secure and all security is ultimately based upon trust. Even in a zero trust security model, someone, somewhere, has to be trusted.\nUltimately it’s a business decision where and who is burdened with that trust.\nTo give a concrete example, we assume that all JSON Web Tokens are valid using Firebase Authentication SDK. For us, Firebase is our golden key and we believe that to be a small (and acceptable) amount of risk.\n Its important before doing any security hardening to know what needs to be secured and what are deemed as acceptable risks.\n Our aims should be:\n Minimize the attack surface. Secure all secrets in a vault. No one should know production passwords. Sanitize all user inputs. Redact sensitive information from logging. Add automated tooling to prevent security flaws before they are merged.  Minimize the attack surface Rather than providing lots of information thats already out there, I recommend:\n Enable Tomcat HTTPS or at least, have HTTPS for all services hitting your ingress. Use a Content Security Policy (CSP) for Cross Site Scripting (XSS) protection. Configure a Cross Site Request Forgery (CSRF) policy. This may include disabling it if using only REST. Test your response headers and remove any that give away more than they should (server type, allowed methods, etc). Use a Web Application Firewall (WAF) to block traffic your services should not serve, e.g. countries you don’t operate in or requests missing a JWT Authorization header.  Also, if your application is only available via REST, I recommend adding a default IndexController to serve browser traffic which is typically automated crawler/bots.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29  /** * This controller is used to handle the case where the application is accessed via a browser. * * We want to return unauthorized to any request to prevent bots and crawlers from accessing the API. */ @Hidden //Hide from Swagger @RestController public class IndexController implements ErrorController { private static final Logger LOGGER = LoggerFactory.getLogger(IndexController.class); @RequestMapping(value = \"/\") public ResponseEntityVoid index() { return ResponseEntity.status(HttpStatus.UNAUTHORIZED).build(); } @RequestMapping(value = \"/error\") public ResponseEntityVoid error() { return ResponseEntity.status(HttpStatus.UNAUTHORIZED).build(); } @RequestMapping(value = \"/robots.txt\") public void robots(final HttpServletRequest request, final HttpServletResponse response) { try { response.getWriter().write(\"User-agent: *\\nDisallow: /\\n\"); } catch (final IOException e) { LOGGER.error(SecurityMarkers.EVENT_FAILURE, \"Failed to write robots.txt\", e); } } }   The above will return 401 for any default or error pages and also return a disallow * for any robots.txt. This should help reduce the amount of crawler traffic.\nChoose a minimal runtime A primary concern is trusting that the runtime on our laptops is identical to production. Ensuring deployed dependencies - and therefore attack surface - is as small as possible.\nA key mitigation strategy is to create a Twelve-Factor App that can be securely tested and deployed by taking the same artifact through each environment. By only changing a few settings, it limits the amount of change and prevents unforeseen drift which leads to vulnerabilities.\nDocker has proven to be a good way to bundle an application and using Spring Profiles you can ensure the application can be configured in predictable ways.\n In a future post we’ll deep dive how to configure automated docker deployments to AWS Fargate using GitHub Actions.\n Configuring Maven Docker While it is possible to manually create a Dockerfile, I’ve found this produces surprisingly large images. It also creates another technology to learn and maintain security updates for.\nWe want a technology that always keeps up to date on every build and can produce a jar with only the required libraries. Luckily, Buildpack can do this for us using a Maven Plugin.\nAdding the following to your pom.xml and running mvn package will produce a docker image.\n1 2 3 4 5 6 7 8 9 10 11 12   org.springframework.boot spring-boot-maven-plugin   ${project.version}  -Xms2048m -Xmx2048m       Compared to a manual Dockerfile I’ve found this image to be much smaller and preconfigured with the correct Java flags.\n I’ve set the maximum allocation pool and initial memory size flags using JAVA_TOOL_OPTIONS. This is important as we want the to automatically set the correct heap size based on a proper memory size. I’ve found that the container does not quite understand its size when this is not set. YMMV.\n The buildpack used is the Bellsoft Liberica JDK. I would recommend also using the same JDK when developing locally to ensure consistency.\nInjecting environment variables You may be wondering, “How do we set things like database connections? They can’t be baked into the image right?\".\nFear not, when we deploy this image we can override any Spring environment variable we want for example, setting @Profile.\n1 2 3 4 5 6   name=\"AWS_REGION\" value=\"eu-west-2\" /  name=\"spring.profiles.active\" value=\"prod\" /  name=\"app.squaddy.api.devMockUser.enabled\" value=\"false\" /  name=\"spring.datasource.username\" value=\"AUserName\" /  name=\"spring.datasource.password\" value=\"************\" /  name=\"spring.datasource.url\" value=\"jdbc:mysql://squaddy.******.eu-west-2.rds.amazonaws.com:3306/db\" /   While our API has around fifty environment settings, the difference between local, integration and production environments are only the most essential ones - database connection, AWS account information, etc. This gives us good confidence that the code we tested and the code being deployed is the same.\nRunning production, locally Now we’re confident that integration and production are similar, we should be able to make the reverse true - our local like integration or production.\nI recommend setting up a configuration in IntelliJ that is identical to integration or production. That way, you can switch over quickly to connect to the real services to aid debugging.\n If you are developing locally, having mock services is fine, but always have a ripcord to switch back to real ones.\n Secure all secrets in a vault Having a web certificate auto renew or a password auto-rotate is truly one of the best things about cloud services. It’s absolutely something you should be using. However, one of the challenges of getting those secrets into the runtime in a performant way.\nCurrently there seems to be two ways of achieving this (on AWS):\n Having the secret pull during runtime. Injecting the secret into build or deployment. Injecting the secret as an environment variable during startup.  They both have pro’s and con’s and go back to risk appetite in the business.\nPull during runtime  Expand for Java example 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59  // Use this code snippet in your app. // If you need more information about configurations or implementing the sample code, visit the AWS docs: // https://docs.aws.amazon.com/sdk-for-java/v1/developer-guide/java-dg-samples.html#prerequisites  public static void getSecret() { String secretName = \"arn:aws:secretsmanager:eu-west-2:260023781495:secret:/secret/squaddy_dev/mysql-TFDMIj\"; Region region = Region.of(\"eu-west-2\"); // Create a Secrets Manager client  SecretsManagerClient client = SecretsManagerClient.builder() .region(region) .build(); // In this sample we only handle the specific exceptions for the 'GetSecretValue' API.  // See https://docs.aws.amazon.com/secretsmanager/latest/apireference/API_GetSecretValue.html  // We rethrow the exception by default.  String secret, decodedBinarySecret; GetSecretValueRequest getSecretValueRequest = GetSecretValueRequest.builder() .secretId(secretName) .build(); GetSecretValueResponse getSecretValueResponse = null; try { getSecretValueResponse = client.getSecretValue(getSecretValueRequest); } catch (DecryptionFailureException e) { // Secrets Manager can't decrypt the protected secret text using the provided KMS key.  // Deal with the exception here, and/or rethrow at your discretion.  throw e; } catch (InternalServiceErrorException e) { // An error occurred on the server side.  // Deal with the exception here, and/or rethrow at your discretion.  throw e; } catch (InvalidParameterException e) { // You provided an invalid value for a parameter.  // Deal with the exception here, and/or rethrow at your discretion.  throw e; } catch (InvalidRequestException e) { // You provided a parameter value that is not valid for the current state of the resource.  // Deal with the exception here, and/or rethrow at your discretion.  throw e; } catch (ResourceNotFoundException e) { // We can't find the resource that you asked for.  // Deal with the exception here, and/or rethrow at your discretion.  throw e; } // Decrypts secret using the associated KMS key.  // Depending on whether the secret is a string or binary, one of these fields will be populated.  if (getSecretValueResponse.secretString() != null) { secret = getSecretValueResponse.secretString(); } else { decodedBinarySecret = new String(Base64.getDecoder().decode(getSecretValueResponse.secretBinary().asByteBuffer()).array()); } // Your code goes here. }     Personally I am not a fan of the first one (which AWS gives the example for). I don’t like having a surprise when the secret doesn’t get pulled in runtime. This could happen for a variety of reasons but configuration/permissions change or network issue both seem like reasonable risks. I like things to fail early, ideally in the build or deployment process.\nInject into build or deployment So why not always use injection? Well theres issues there too. Injecting a secret into the build is a no go as it breaks the Twelve-Factor App principle.\nInject as environment variable during startup Finally, we have injecting the secret as an environment variable. This is commonly seen in AWS provided examples using Lambda.\nIt’s possible (although not well documented) that you can use a ECS Task Definition to get secrets during startup:\n1 2 3 4 5 6  \"secrets\": [ { \"name\": \"spring.datasource.password\", \"valueFrom\": \"arn:aws:secretsmanager:eu-west-2:12345:secret:/secret/squaddy/mysql-:12345::password::\" }, ]   This one I like the most as it keeps secrets separate and not ‘baked in’. The negatives are:\n If secrets rotation will cause errors if they rotate during the runtime. Other issues may also arise if the secret needs to change. The secrets are in plain text in the AWS Console.  Sanitize all user inputs A key strategy in defensive programming is not to trust anything another client or user gives you. This doesn’t just mean security, it also means ‘bad data’.\nEnsure you understand who your client is Your tolerance for what a ‘client’ means can vary between teams and businesses. For example, in a microservice architecture, do you trust other services? What about third party webhooks? Does having a shared secret or SSL help?\nCommon sanitization techniques Here’s an example from the Squaddy API:\n1 2 3 4 5 6 7 8 9 10 11 12 13  @PostMapping(value = \"/group/chat\") public ResponseEntityUploadRequestResponseDTO generateChatFileSignedUrl(@RequestParam(\"mimeType\") @NotBlank(message = \"MimeType must not be blank.\") final String mimeType, @RequestParam(\"extension\") @NotBlank(message = \"Extension must not be blank.\") final String extension, @RequestParam(\"groupId\") @Min(value = 1L, message = \"The value must be positive.\") final Long groupId) { final var safeMimeType = Encode.forJava(mimeType); final var safeExtension = Encode.forJava(extension); return new ResponseEntity( storageService.generateSignedUrl(safeMimeType.toLowerCase(Locale.ROOT), safeExtension.toUpperCase(Locale.ROOT), groupId.toString()), HttpStatus.CREATED ); }   Firstly, I highly recommend using Spring Validation to check the inputs. For example @Min will reject any groupId less than 1.\nSecondly, know mimeType and extension will be present (as it must pass @NotBlank), we can’t be sure they are safe as they are strings. Common techniques to resolve this would be to trim whitespace or emoji’s from strings by running through regex to only allow numbers or alphanumeric. I am not a fan of this approach. Regex is famously complicated and I would recommend instead using the OWASP Java Encoder.\nFinally, you’ll note that we don’t do any sanitization on groupId. We know this to be a integer and (hopefully) fairly safe.\nThe key takeaways here are:\n A mix of validation and sanitization is required. No one approach is enough. Use a proper library over rolling your own regex or trimming. It’s cleaner and less prone to errors.  Redact sensitive information from logging One overlooked aspect to security is logging. When developing locally logging feels cheap but once deployed to production is hard to see the wood for the trees.\nThere are a few things to remember when it comes to security and logging:\nMask your logs Here is a quick introduction to adding owasp-security-logging and masking.\nAdd the following to your pom.xml:\n1 2 3 4 5   org.owasp security-logging-logback LATEST    Now make sure to update any LOGGER calls with a new SecurityMarker.\n1 2  LOGGER.info(\"userid={}\", userid); LOGGER.info(SecurityMarkers.CONFIDENTIAL, \"password={}\", password);   This will later produce something similar to:\n1 2  2014-12-16 13:54:48,860 [main] INFO - userid=joebob 2014-12-16 13:54:48,860 [main] [CONFIDENTIAL] INFO - password=***********   As you can see, the second line as been redacted due to being CONFIDENTIAL.\nDon’t over log. Using Log Levels, owasp-security-logging and logstash-logback-encoder  a useful (but redacted) log can be produced.\n1  LOGGER.debug(SecurityMarkers.SECURITY_AUDIT, CHECKING_USER_MESSAGE, firebaseId);   Will produce:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  { \"@timestamp\": \"2021-12-28T14:42:54.118Z\", \"@version\": \"1\", \"message\": \"Checking user exists: **********************\", // Redacted  \"logger_name\": \"app.squaddy.api.persistence.UserPersistenceService\", \"thread_name\": \"http-nio-8080-exec-9\", \"level\": \"DEBUG\", \"level_value\": 10000, \"transaction.id\": \"8b6f99ac-272e-4476-b29c-e0f75cc87bd0\", // A unique id for this request  \"transaction.requestMethod\": \"GET\", \"transaction.requestUrl\": \"/v2/user/groups/0\", \"transaction.proxyRemoteIp\": \"*****\", // Redacted  \"transaction.firebaseId\": \"**********************\", // Redacted  \"transaction.host\": \"api.squaddy.app\", \"transaction.remoteIp\": \"10.0.0.159\", \"transaction.isPublicApi\": \"false\", \"transaction.userAgent\": \"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/96.0.4664.110 Safari/537.36\", \"tags\": [ \"SECURITY AUDIT\" // A security marker added  ] }    By using a security markers and using levels we can restrict the overhead of logging for each environment without altering code.\n Encode your logs Log Forging or Log Injection is one of the top OWASP vulnerabilities and not often talked about. The same owasp-security-logging library can also be configured add CRLF encoding to any logged text.\nFor example:\n1 2 3 4 5 6 7   conversionWord=\"crlf\" converterClass=\"org.owasp.security.logging.mask.CRLFConverter\" /  class=\"ch.qos.logback.classic.PatternLayout\" STDOUT %d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %crlf(%msg) %n     I would also recommend switching to JSON in production over using standard console out as it’s a far more flexible (and searchable) format.\nAdd automated tooling to prevent security flaws before they are merged. A final piece in the puzzle is to introduce more automation. There are many options for static code analysis and as usual a mix (and configuration) is required to get a balanced view.\nAt Squaddy we use SonarQube’s hosted SonarCloud and Snyk. They both have excellent IntelliJ plugins and integrate well with GitHub Actions.\nAs mentioned no tool is perfect and SonarQube in particular can sometimes blur the lines between “we think this looks better”, “we believe this to be bad practice” and “this is a very bad security practice”. However on balance they are an absolute upgrade and even if after a bit of research I disagree, I am at least wiser for it.\nConclusion Thank you for reading and I hope this was useful. My intention was not to deep dive any one subject but more to provide thought on various aspects to security. There is no one size fits all and it doesn’t all need to happen in Sprint 0.\nUltimately security is an on-going and multi aspect concern. I’ve learnt over time that the better you understand your business needs, the easier it is to make security decisions.\n","wordCount":"2549","inLanguage":"en","datePublished":"2021-12-28T01:00:00Z","dateModified":"2021-12-28T01:00:00Z","author":{"@type":"Person","name":"Tom Beckett"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://tombeckett.github.io/posts/spring-security-hardening/"},"publisher":{"@type":"Organization","name":"Tom Beckett","logo":{"@type":"ImageObject","url":"https://tombeckett.github.io/%3Clink%20/%20abs%20url%3E"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://tombeckett.github.io/ accesskey=h title="Tom Beckett (Alt + H)">Tom Beckett</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</span>
</div>
<ul id=menu>
<li>
<a href=https://tombeckett.github.io/categories/ title=Categories>
<span>Categories</span>
</a>
</li>
<li>
<a href=https://tombeckett.github.io/tags/ title=Tags>
<span>Tags</span>
</a>
</li>
<li>
<a href=https://tombeckett.github.io/search/ title="Search (Alt + /)" accesskey=/>
<span>Search</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<div class=breadcrumbs><a href=https://tombeckett.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://tombeckett.github.io/posts/>Posts</a></div>
<h1 class=post-title>
Spring Boot: Security Hardening
</h1>
<div class=post-meta><span title="2021-12-28 01:00:00 +0000 UTC">December 28, 2021</span>&nbsp;·&nbsp;12 min&nbsp;·&nbsp;Tom Beckett&nbsp;|&nbsp;<a href=https://github.com/TomBeckett/tombeckett.github.io/tree/main/content/posts/spring-security-hardening.md rel="noopener noreferrer" target=_blank>Suggest Changes</a>
</div>
</header>
<div class=post-content><p>When working on the <a href=https://squaddy.app>Squaddy App</a> I&rsquo;ve seen a LOT of <a href=https://en.wikipedia.org/wiki/Internet_background_noise>internet background noise</a> in our logs. It&rsquo;s especially timely given the recent <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-45105">Log4j2 Remote Code Execution</a> exploit.</p>
<p>We&rsquo;ve done a lot of work to ensure we stay as safe as possible and I wanted to go through some recommendations.</p>
<h2 id=what-we-mean-by-safe>What we mean by &lsquo;Safe&rsquo;?<a hidden class=anchor aria-hidden=true href=#what-we-mean-by-safe>#</a></h2>
<p>Whenever talking about security we&rsquo;re really asking <em>&ldquo;How confident am I this will work as I expect?"</em>. No system is entirely secure and all security is ultimately based upon trust. Even in a <a href=https://en.wikipedia.org/wiki/Zero_trust_security_model>zero trust security model</a>, someone, somewhere, has to be trusted.</p>
<p>Ultimately it&rsquo;s a business decision where and who is burdened with that trust.</p>
<p>To give a concrete example, we assume that all <a href=https://en.wikipedia.org/wiki/JSON_Web_Token>JSON Web Tokens</a> are valid using <a href=https://firebase.google.com/docs/auth>Firebase Authentication SDK</a>. For us, Firebase is our golden key and we believe that to be a small (and acceptable) amount of risk.</p>
<blockquote>
<p>Its important before doing <em>any</em> security hardening to know what needs to be secured and what are deemed as acceptable risks.</p>
</blockquote>
<p>Our aims should be:</p>
<ul>
<li><a href=#minimize-the-attack-surface>Minimize the attack surface.</a></li>
<li><a href=#secure-all-secrets-in-a-vault>Secure all secrets in a vault.</a> <em>No one should know production passwords.</em></li>
<li><a href=#sanitize-all-user-inputs>Sanitize all user inputs.</a></li>
<li><a href=#redact-sensitive-information-from-logging>Redact sensitive information from logging.</a></li>
<li><a href=#add-automated-tooling-to-prevent-security-flaws-before-they-are-merged>Add automated tooling to prevent security flaws before they are merged.</a></li>
</ul>
<h2 id=minimize-the-attack-surface>Minimize the attack surface<a hidden class=anchor aria-hidden=true href=#minimize-the-attack-surface>#</a></h2>
<p>Rather than providing lots of information thats already out there, I recommend:</p>
<ul>
<li><a href=https://www.mulesoft.com/tcat/tomcat-ssl>Enable Tomcat HTTPS</a> or at least, have HTTPS for all services hitting your ingress.</li>
<li><a href=https://docs.spring.io/spring-security/site/docs/5.2.0.RELEASE/reference/html/default-security-headers-2.html#webflux-headers-csp>Use a Content Security Policy (CSP)</a> for Cross Site Scripting (XSS) protection.</li>
<li><a href=https://docs.spring.io/spring-security/site/docs/5.0.x/reference/html/csrf.html>Configure a Cross Site Request Forgery (CSRF) policy</a>. This <em>may</em> include disabling it if using only REST.</li>
<li><a href=https://gf.dev/http-headers-test>Test your response headers</a> and remove any that give away more than they should (server type, allowed methods, etc).</li>
<li><a href=https://aws.amazon.com/waf/>Use a Web Application Firewall (WAF)</a> to block traffic your services should not serve, e.g. countries you don&rsquo;t operate in or requests missing a JWT <code>Authorization</code> header.</li>
</ul>
<p>Also, if your application is only available via REST, I recommend adding a default <code>IndexController</code> to serve browser traffic which is typically automated crawler/bots.</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#75715e>/**
</span><span style=color:#75715e> * This controller is used to handle the case where the application is accessed via a browser.
</span><span style=color:#75715e> * &lt;/p&gt;
</span><span style=color:#75715e> * We want to return unauthorized to any request to prevent bots and crawlers from accessing the API.
</span><span style=color:#75715e> */</span>
<span style=color:#a6e22e>@Hidden</span> <span style=color:#75715e>//Hide from Swagger
</span><span style=color:#75715e></span><span style=color:#a6e22e>@RestController</span>
<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>IndexController</span> <span style=color:#66d9ef>implements</span> ErrorController <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> Logger LOGGER <span style=color:#f92672>=</span> LoggerFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>getLogger</span><span style=color:#f92672>(</span>IndexController<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>

    <span style=color:#a6e22e>@RequestMapping</span><span style=color:#f92672>(</span>value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/&#34;</span><span style=color:#f92672>)</span>
    <span style=color:#66d9ef>public</span> ResponseEntity<span style=color:#f92672>&lt;</span>Void<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>index</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>return</span> ResponseEntity<span style=color:#f92672>.</span><span style=color:#a6e22e>status</span><span style=color:#f92672>(</span>HttpStatus<span style=color:#f92672>.</span><span style=color:#a6e22e>UNAUTHORIZED</span><span style=color:#f92672>).</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
    <span style=color:#f92672>}</span>

    <span style=color:#a6e22e>@RequestMapping</span><span style=color:#f92672>(</span>value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/error&#34;</span><span style=color:#f92672>)</span>
    <span style=color:#66d9ef>public</span> ResponseEntity<span style=color:#f92672>&lt;</span>Void<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>error</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>return</span> ResponseEntity<span style=color:#f92672>.</span><span style=color:#a6e22e>status</span><span style=color:#f92672>(</span>HttpStatus<span style=color:#f92672>.</span><span style=color:#a6e22e>UNAUTHORIZED</span><span style=color:#f92672>).</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
    <span style=color:#f92672>}</span>

    <span style=color:#a6e22e>@RequestMapping</span><span style=color:#f92672>(</span>value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/robots.txt&#34;</span><span style=color:#f92672>)</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>robots</span><span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> HttpServletRequest request<span style=color:#f92672>,</span> <span style=color:#66d9ef>final</span> HttpServletResponse response<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
            response<span style=color:#f92672>.</span><span style=color:#a6e22e>getWriter</span><span style=color:#f92672>().</span><span style=color:#a6e22e>write</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;User-agent: *\nDisallow: /\n&#34;</span><span style=color:#f92672>);</span>
        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> IOException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            LOGGER<span style=color:#f92672>.</span><span style=color:#a6e22e>error</span><span style=color:#f92672>(</span>SecurityMarkers<span style=color:#f92672>.</span><span style=color:#a6e22e>EVENT_FAILURE</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Failed to write robots.txt&#34;</span><span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
        <span style=color:#f92672>}</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></td></tr></table>
</div>
</div><p>The above will return <code>401</code> for any default or error pages and also return a <code>disallow *</code> for any <code>robots.txt</code>. This should help reduce the amount of crawler traffic.</p>
<h3 id=choose-a-minimal-runtime>Choose a minimal runtime<a hidden class=anchor aria-hidden=true href=#choose-a-minimal-runtime>#</a></h3>
<p>A primary concern is trusting that the runtime on our laptops is identical to production. Ensuring deployed dependencies - and therefore attack surface - is as small as possible.</p>
<p>A key mitigation strategy is to create a <a href=https://12factor.net/>Twelve-Factor App</a> that can be securely tested and deployed by taking the same artifact through each environment. By only changing a few settings, it limits the amount of change and prevents unforeseen drift which leads to vulnerabilities.</p>
<p><a href=https://www.docker.com/>Docker</a> has proven to be a good way to bundle an application and using <a href=https://docs.spring.io/spring-boot/docs/1.2.0.M1/reference/html/boot-features-profiles.html>Spring Profiles</a> you can ensure the application can be configured in predictable ways.</p>
<blockquote>
<p>In a future post we&rsquo;ll deep dive how to configure automated docker deployments to AWS Fargate using GitHub Actions.</p>
</blockquote>
<h3 id=configuring-maven-docker>Configuring Maven Docker<a hidden class=anchor aria-hidden=true href=#configuring-maven-docker>#</a></h3>
<p>While it is possible to manually create a Dockerfile, I&rsquo;ve found this produces surprisingly large images. It also creates <em>another</em> technology to learn and maintain security updates for.</p>
<p>We want a technology that always keeps up to date on every build and can produce a jar with only the required libraries. Luckily, <a href=https://buildpacks.io/>Buildpack</a> can do this for us using a <a href=https://spring.io/blog/2020/01/27/creating-docker-images-with-spring-boot-2-3-0-m1>Maven Plugin</a>.</p>
<p>Adding the following to your <code>pom.xml</code> and running <code>mvn package</code> will produce a docker image.</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#f92672>&lt;plugin&gt;</span>
    <span style=color:#f92672>&lt;groupId&gt;</span>org.springframework.boot<span style=color:#f92672>&lt;/groupId&gt;</span>
    <span style=color:#f92672>&lt;artifactId&gt;</span>spring-boot-maven-plugin<span style=color:#f92672>&lt;/artifactId&gt;</span>
    <span style=color:#f92672>&lt;configuration&gt;</span>
        <span style=color:#f92672>&lt;image&gt;</span>
            <span style=color:#f92672>&lt;name&gt;</span>${project.version}<span style=color:#f92672>&lt;/name&gt;</span>
            <span style=color:#f92672>&lt;env&gt;</span>
                <span style=color:#f92672>&lt;JAVA_TOOL_OPTIONS&gt;</span>-Xms2048m -Xmx2048m<span style=color:#f92672>&lt;/JAVA_TOOL_OPTIONS&gt;</span>
            <span style=color:#f92672>&lt;/env&gt;</span>
        <span style=color:#f92672>&lt;/image&gt;</span>
    <span style=color:#f92672>&lt;/configuration&gt;</span>
<span style=color:#f92672>&lt;/plugin&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>Compared to a manual Dockerfile I&rsquo;ve found this image to be much smaller and preconfigured with the correct Java flags.</p>
<blockquote>
<p>I&rsquo;ve set the maximum allocation pool and initial memory size flags using <code>JAVA_TOOL_OPTIONS</code>. This is important as we want the to automatically set the correct heap size based on a proper memory size. I&rsquo;ve found that the container does not quite understand its size when this is not set. YMMV.</p>
</blockquote>
<p>The buildpack used is the <a href=https://github.com/paketo-buildpacks/bellsoft-liberica>Bellsoft Liberica</a> JDK. I would recommend also using the same JDK when developing locally to ensure consistency.</p>
<h3 id=injecting-environment-variables>Injecting environment variables<a hidden class=anchor aria-hidden=true href=#injecting-environment-variables>#</a></h3>
<p>You may be wondering, <em>&ldquo;How do we set things like database connections? They can&rsquo;t be baked into the image right?"</em>.</p>
<p>Fear not, when we deploy this image we can override any Spring environment variable we want for example, setting <a href=https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/context/annotation/Profile.html>@Profile</a>.</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#f92672>&lt;env</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#34;AWS_REGION&#34;</span> <span style=color:#a6e22e>value=</span><span style=color:#e6db74>&#34;eu-west-2&#34;</span> <span style=color:#f92672>/&gt;</span>
<span style=color:#f92672>&lt;env</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#34;spring.profiles.active&#34;</span> <span style=color:#a6e22e>value=</span><span style=color:#e6db74>&#34;prod&#34;</span> <span style=color:#f92672>/&gt;</span>
<span style=color:#f92672>&lt;env</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#34;app.squaddy.api.devMockUser.enabled&#34;</span> <span style=color:#a6e22e>value=</span><span style=color:#e6db74>&#34;false&#34;</span> <span style=color:#f92672>/&gt;</span>
<span style=color:#f92672>&lt;env</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#34;spring.datasource.username&#34;</span> <span style=color:#a6e22e>value=</span><span style=color:#e6db74>&#34;AUserName&#34;</span> <span style=color:#f92672>/&gt;</span>
<span style=color:#f92672>&lt;env</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#34;spring.datasource.password&#34;</span> <span style=color:#a6e22e>value=</span><span style=color:#e6db74>&#34;************&#34;</span> <span style=color:#f92672>/&gt;</span>
<span style=color:#f92672>&lt;env</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#34;spring.datasource.url&#34;</span> <span style=color:#a6e22e>value=</span><span style=color:#e6db74>&#34;jdbc:mysql://squaddy.******.eu-west-2.rds.amazonaws.com:3306/db&#34;</span> <span style=color:#f92672>/&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>While our API has around fifty environment settings, the difference between <code>local</code>, <code>integration</code> and <code>production</code> environments are only the most essential ones - database connection, AWS account information, etc. This gives us good confidence that the code we tested and the code being deployed is the same.</p>
<h3 id=running-production-locally>Running production, locally<a hidden class=anchor aria-hidden=true href=#running-production-locally>#</a></h3>
<p>Now we&rsquo;re confident that <code>integration</code> and <code>production</code> are similar, we should be able to make the reverse true - our <code>local</code> like <code>integration</code> or <code>production</code>.</p>
<p>I recommend setting up a configuration in <a href=https://www.jetbrains.com/help/idea/run-debug-configuration.html>IntelliJ</a> that is identical to <code>integration</code> or <code>production</code>. That way, you can switch over quickly to connect to the real services to aid debugging.</p>
<blockquote>
<p>If you are developing locally, having mock services is fine, but always have a ripcord to switch back to real ones.</p>
</blockquote>
<h2 id=secure-all-secrets-in-a-vault>Secure all secrets in a vault<a hidden class=anchor aria-hidden=true href=#secure-all-secrets-in-a-vault>#</a></h2>
<p>Having a web certificate auto renew or a password auto-rotate is truly one of the best things about <a href=https://en.wikipedia.org/wiki/Cloud_computing>cloud services</a>. It&rsquo;s absolutely something you should be using. However, one of the challenges of getting those secrets into the runtime in a performant way.</p>
<p>Currently there seems to be two ways of achieving this (on AWS):</p>
<ul>
<li><a href=#pull-during-runtime>Having the secret pull during runtime.</a></li>
<li><a href=#inject-into-build-or-deployment>Injecting the secret into build or deployment.</a></li>
<li><a href=#inject-as-environment-variable-during-startup>Injecting the secret as an environment variable during startup.</a></li>
</ul>
<p>They both have pro&rsquo;s and con&rsquo;s and go back to risk appetite in the business.</p>
<h3 id=pull-during-runtime>Pull during runtime<a hidden class=anchor aria-hidden=true href=#pull-during-runtime>#</a></h3>
<details>
<summary>Expand for Java example</summary>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#75715e>// Use this code snippet in your app.
</span><span style=color:#75715e>// If you need more information about configurations or implementing the sample code, visit the AWS docs:
</span><span style=color:#75715e>// https://docs.aws.amazon.com/sdk-for-java/v1/developer-guide/java-dg-samples.html#prerequisites
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>getSecret</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>

    String secretName <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;arn:aws:secretsmanager:eu-west-2:260023781495:secret:/secret/squaddy_dev/mysql-TFDMIj&#34;</span><span style=color:#f92672>;</span>
    Region region <span style=color:#f92672>=</span> Region<span style=color:#f92672>.</span><span style=color:#a6e22e>of</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;eu-west-2&#34;</span><span style=color:#f92672>);</span>

    <span style=color:#75715e>// Create a Secrets Manager client
</span><span style=color:#75715e></span>    SecretsManagerClient client <span style=color:#f92672>=</span> SecretsManagerClient<span style=color:#f92672>.</span><span style=color:#a6e22e>builder</span><span style=color:#f92672>()</span>
            <span style=color:#f92672>.</span><span style=color:#a6e22e>region</span><span style=color:#f92672>(</span>region<span style=color:#f92672>)</span>
            <span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>

    <span style=color:#75715e>// In this sample we only handle the specific exceptions for the &#39;GetSecretValue&#39; API.
</span><span style=color:#75715e></span>    <span style=color:#75715e>// See https://docs.aws.amazon.com/secretsmanager/latest/apireference/API_GetSecretValue.html
</span><span style=color:#75715e></span>    <span style=color:#75715e>// We rethrow the exception by default.
</span><span style=color:#75715e></span>
    String secret<span style=color:#f92672>,</span> decodedBinarySecret<span style=color:#f92672>;</span>
    GetSecretValueRequest getSecretValueRequest <span style=color:#f92672>=</span> GetSecretValueRequest<span style=color:#f92672>.</span><span style=color:#a6e22e>builder</span><span style=color:#f92672>()</span>
            <span style=color:#f92672>.</span><span style=color:#a6e22e>secretId</span><span style=color:#f92672>(</span>secretName<span style=color:#f92672>)</span>
            <span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
    GetSecretValueResponse getSecretValueResponse <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>

    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
        getSecretValueResponse <span style=color:#f92672>=</span> client<span style=color:#f92672>.</span><span style=color:#a6e22e>getSecretValue</span><span style=color:#f92672>(</span>getSecretValueRequest<span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>DecryptionFailureException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#75715e>// Secrets Manager can&#39;t decrypt the protected secret text using the provided KMS key.
</span><span style=color:#75715e></span>        <span style=color:#75715e>// Deal with the exception here, and/or rethrow at your discretion.
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>throw</span> e<span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>InternalServiceErrorException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#75715e>// An error occurred on the server side.
</span><span style=color:#75715e></span>        <span style=color:#75715e>// Deal with the exception here, and/or rethrow at your discretion.
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>throw</span> e<span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>InvalidParameterException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#75715e>// You provided an invalid value for a parameter.
</span><span style=color:#75715e></span>        <span style=color:#75715e>// Deal with the exception here, and/or rethrow at your discretion.
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>throw</span> e<span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>InvalidRequestException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#75715e>// You provided a parameter value that is not valid for the current state of the resource.
</span><span style=color:#75715e></span>        <span style=color:#75715e>// Deal with the exception here, and/or rethrow at your discretion.
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>throw</span> e<span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>ResourceNotFoundException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#75715e>// We can&#39;t find the resource that you asked for.
</span><span style=color:#75715e></span>        <span style=color:#75715e>// Deal with the exception here, and/or rethrow at your discretion.
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>throw</span> e<span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>

    <span style=color:#75715e>// Decrypts secret using the associated KMS key.
</span><span style=color:#75715e></span>    <span style=color:#75715e>// Depending on whether the secret is a string or binary, one of these fields will be populated.
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>getSecretValueResponse<span style=color:#f92672>.</span><span style=color:#a6e22e>secretString</span><span style=color:#f92672>()</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        secret <span style=color:#f92672>=</span> getSecretValueResponse<span style=color:#f92672>.</span><span style=color:#a6e22e>secretString</span><span style=color:#f92672>();</span>
    <span style=color:#f92672>}</span>
    <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
        decodedBinarySecret <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> String<span style=color:#f92672>(</span>Base64<span style=color:#f92672>.</span><span style=color:#a6e22e>getDecoder</span><span style=color:#f92672>().</span><span style=color:#a6e22e>decode</span><span style=color:#f92672>(</span>getSecretValueResponse<span style=color:#f92672>.</span><span style=color:#a6e22e>secretBinary</span><span style=color:#f92672>().</span><span style=color:#a6e22e>asByteBuffer</span><span style=color:#f92672>()).</span><span style=color:#a6e22e>array</span><span style=color:#f92672>());</span>
    <span style=color:#f92672>}</span>

    <span style=color:#75715e>// Your code goes here.
</span><span style=color:#75715e></span><span style=color:#f92672>}</span>
</code></pre></td></tr></table>
</div>
</div>
</details>
<p>Personally I am not a fan of the first one (which AWS gives the example for). I don&rsquo;t like having a surprise when the secret doesn&rsquo;t get pulled in runtime. This could happen for a variety of reasons but configuration/permissions change or network issue both seem like reasonable risks. I like things to fail early, ideally in the build or deployment process.</p>
<h3 id=inject-into-build-or-deployment>Inject into build or deployment<a hidden class=anchor aria-hidden=true href=#inject-into-build-or-deployment>#</a></h3>
<p>So why not always use injection? Well theres issues there too. Injecting a secret into the build is a <em>no go</em> as it breaks the <a href=https://12factor.net/>Twelve-Factor App</a> principle.</p>
<h3 id=inject-as-environment-variable-during-startup>Inject as environment variable during startup<a hidden class=anchor aria-hidden=true href=#inject-as-environment-variable-during-startup>#</a></h3>
<p>Finally, we have injecting the secret as an environment variable. This is commonly seen in <a href=https://aws.amazon.com/blogs/security/how-to-securely-provide-database-credentials-to-lambda-functions-by-using-aws-secrets-manager/>AWS provided examples using Lambda</a>.</p>
<p>It&rsquo;s possible (although not well documented) that you can use a <a href=https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ecs-taskdefinition.html>ECS Task Definition</a> to get secrets during startup:</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#e6db74>&#34;secrets&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> [
    {
        <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;spring.datasource.password&#34;</span>,
        <span style=color:#f92672>&#34;valueFrom&#34;</span>: <span style=color:#e6db74>&#34;arn:aws:secretsmanager:eu-west-2:12345:secret:/secret/squaddy/mysql-:12345::password::&#34;</span>
    },
]
</code></pre></td></tr></table>
</div>
</div><p>This one I like the most as it keeps secrets separate and not &lsquo;baked in&rsquo;. The negatives are:</p>
<ul>
<li>If secrets rotation will cause errors if they rotate during the runtime.</li>
<li>Other issues may also arise if the secret needs to change.</li>
<li>The secrets are in plain text in the AWS Console.</li>
</ul>
<h2 id=sanitize-all-user-inputs>Sanitize all user inputs<a hidden class=anchor aria-hidden=true href=#sanitize-all-user-inputs>#</a></h2>
<p>A key strategy in <a href=https://en.wikipedia.org/wiki/Defensive_programming>defensive programming</a> is not to trust anything another client or user gives you. This doesn&rsquo;t just mean security, it also means &lsquo;bad data&rsquo;.</p>
<h3 id=ensure-you-understand-who-your-client-is>Ensure you understand who your client is<a hidden class=anchor aria-hidden=true href=#ensure-you-understand-who-your-client-is>#</a></h3>
<p>Your tolerance for what a <em>&lsquo;client&rsquo;</em> means can vary between teams and businesses. For example, in a microservice architecture, do you trust other services? What about third party webhooks? Does having a shared secret or SSL help?</p>
<h3 id=common-sanitization-techniques>Common sanitization techniques<a hidden class=anchor aria-hidden=true href=#common-sanitization-techniques>#</a></h3>
<p>Here&rsquo;s an example from the Squaddy API:</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a6e22e>@PostMapping</span><span style=color:#f92672>(</span>value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/group/chat&#34;</span><span style=color:#f92672>)</span>
<span style=color:#66d9ef>public</span> ResponseEntity<span style=color:#f92672>&lt;</span>UploadRequestResponseDTO<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>generateChatFileSignedUrl</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@RequestParam</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;mimeType&#34;</span><span style=color:#f92672>)</span>
                                                                          <span style=color:#a6e22e>@NotBlank</span><span style=color:#f92672>(</span>message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;MimeType must not be blank.&#34;</span><span style=color:#f92672>)</span> <span style=color:#66d9ef>final</span> String mimeType<span style=color:#f92672>,</span>
                                                                          <span style=color:#a6e22e>@RequestParam</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;extension&#34;</span><span style=color:#f92672>)</span>
                                                                          <span style=color:#a6e22e>@NotBlank</span><span style=color:#f92672>(</span>message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Extension must not be blank.&#34;</span><span style=color:#f92672>)</span> <span style=color:#66d9ef>final</span> String extension<span style=color:#f92672>,</span>
                                                                          <span style=color:#a6e22e>@RequestParam</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;groupId&#34;</span><span style=color:#f92672>)</span>
                                                                          <span style=color:#a6e22e>@Min</span><span style=color:#f92672>(</span>value <span style=color:#f92672>=</span> 1L<span style=color:#f92672>,</span> message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;The value must be positive.&#34;</span><span style=color:#f92672>)</span> <span style=color:#66d9ef>final</span> Long groupId<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>final</span> var safeMimeType <span style=color:#f92672>=</span> Encode<span style=color:#f92672>.</span><span style=color:#a6e22e>forJava</span><span style=color:#f92672>(</span>mimeType<span style=color:#f92672>);</span>
    <span style=color:#66d9ef>final</span> var safeExtension <span style=color:#f92672>=</span> Encode<span style=color:#f92672>.</span><span style=color:#a6e22e>forJava</span><span style=color:#f92672>(</span>extension<span style=color:#f92672>);</span>
    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> ResponseEntity<span style=color:#f92672>&lt;&gt;(</span>
            storageService<span style=color:#f92672>.</span><span style=color:#a6e22e>generateSignedUrl</span><span style=color:#f92672>(</span>safeMimeType<span style=color:#f92672>.</span><span style=color:#a6e22e>toLowerCase</span><span style=color:#f92672>(</span>Locale<span style=color:#f92672>.</span><span style=color:#a6e22e>ROOT</span><span style=color:#f92672>),</span> safeExtension<span style=color:#f92672>.</span><span style=color:#a6e22e>toUpperCase</span><span style=color:#f92672>(</span>Locale<span style=color:#f92672>.</span><span style=color:#a6e22e>ROOT</span><span style=color:#f92672>),</span> groupId<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>()),</span> HttpStatus<span style=color:#f92672>.</span><span style=color:#a6e22e>CREATED</span>
    <span style=color:#f92672>);</span>
<span style=color:#f92672>}</span>
</code></pre></td></tr></table>
</div>
</div><p>Firstly, I highly recommend using <a href=https://www.baeldung.com/javax-validation>Spring Validation</a> to check the inputs. For example <code>@Min</code> will reject any <code>groupId</code> less than 1.</p>
<p>Secondly, know <code>mimeType</code> and <code>extension</code> will be present (as it must pass <code>@NotBlank</code>), we can&rsquo;t be sure they are safe as they are strings. Common techniques to resolve this would be to trim whitespace or emoji&rsquo;s from strings by running through regex to only allow numbers or alphanumeric. I am not a fan of this approach. <a href=https://xkcd.com/208/>Regex is famously complicated</a> and I would recommend instead using the <a href=https://owasp.org/www-project-java-encoder/>OWASP Java Encoder</a>.</p>
<p>Finally, you&rsquo;ll note that we don&rsquo;t do any sanitization on <code>groupId</code>. We know this to be a integer and (hopefully) fairly safe.</p>
<p>The key takeaways here are:</p>
<ul>
<li>A mix of validation and sanitization is required. No one approach is enough.</li>
<li>Use a proper library over rolling your own regex or trimming. It&rsquo;s cleaner and less prone to errors.</li>
</ul>
<h2 id=redact-sensitive-information-from-logging>Redact sensitive information from logging<a hidden class=anchor aria-hidden=true href=#redact-sensitive-information-from-logging>#</a></h2>
<p>One overlooked aspect to security is logging. When developing locally logging feels cheap but once deployed to production is hard to see the wood for the trees.</p>
<p>There are a few things to remember when it comes to security and logging:</p>
<h3 id=mask-your-logs>Mask your logs<a hidden class=anchor aria-hidden=true href=#mask-your-logs>#</a></h3>
<p>Here is a quick introduction to adding <a href=https://github.com/javabeanz/owasp-security-logging>owasp-security-logging</a> and masking.</p>
<p>Add the following to your <code>pom.xml</code>:</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#f92672>&lt;dependency&gt;</span>
  <span style=color:#f92672>&lt;groupId&gt;</span>org.owasp<span style=color:#f92672>&lt;/groupId&gt;</span>
  <span style=color:#f92672>&lt;artifactId&gt;</span>security-logging-logback<span style=color:#f92672>&lt;/artifactId&gt;</span>
  <span style=color:#f92672>&lt;version&gt;</span>LATEST<span style=color:#f92672>&lt;/version&gt;</span>
<span style=color:#f92672>&lt;/dependency&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>Now make sure to update any <code>LOGGER</code> calls with a new <code>SecurityMarker</code>.</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>LOGGER<span style=color:#f92672>.</span><span style=color:#a6e22e>info</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;userid={}&#34;</span><span style=color:#f92672>,</span> userid<span style=color:#f92672>);</span>  
LOGGER<span style=color:#f92672>.</span><span style=color:#a6e22e>info</span><span style=color:#f92672>(</span>SecurityMarkers<span style=color:#f92672>.</span><span style=color:#a6e22e>CONFIDENTIAL</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;password={}&#34;</span><span style=color:#f92672>,</span> password<span style=color:#f92672>);</span>
</code></pre></td></tr></table>
</div>
</div><p>This will later produce something similar to:</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>2014-12-16 13:54:48,860 <span style=color:#f92672>[</span>main<span style=color:#f92672>]</span> INFO - userid<span style=color:#f92672>=</span>joebob
2014-12-16 13:54:48,860 <span style=color:#f92672>[</span>main<span style=color:#f92672>]</span> <span style=color:#f92672>[</span>CONFIDENTIAL<span style=color:#f92672>]</span> INFO - password<span style=color:#f92672>=</span>***********
</code></pre></td></tr></table>
</div>
</div><p>As you can see, the second line as been redacted due to being <code>CONFIDENTIAL</code>.</p>
<h3 id=dont-over-log>Don&rsquo;t over log.<a hidden class=anchor aria-hidden=true href=#dont-over-log>#</a></h3>
<p>Using <a href=https://docs.spring.io/spring-boot/docs/2.1.13.RELEASE/reference/html/boot-features-logging.html>Log Levels</a>, <a href=https://github.com/javabeanz/owasp-security-logging>owasp-security-logging</a> and <a href=https://github.com/logfellow/logstash-logback-encoder>logstash-logback-encoder
</a> a useful (but redacted) log can be produced.</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>LOGGER<span style=color:#f92672>.</span><span style=color:#a6e22e>debug</span><span style=color:#f92672>(</span>SecurityMarkers<span style=color:#f92672>.</span><span style=color:#a6e22e>SECURITY_AUDIT</span><span style=color:#f92672>,</span> CHECKING_USER_MESSAGE<span style=color:#f92672>,</span> firebaseId<span style=color:#f92672>);</span>
</code></pre></td></tr></table>
</div>
</div><p>Will produce:</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
    <span style=color:#f92672>&#34;@timestamp&#34;</span>: <span style=color:#e6db74>&#34;2021-12-28T14:42:54.118Z&#34;</span>,
    <span style=color:#f92672>&#34;@version&#34;</span>: <span style=color:#e6db74>&#34;1&#34;</span>,
    <span style=color:#f92672>&#34;message&#34;</span>: <span style=color:#e6db74>&#34;Checking user exists: **********************&#34;</span>, <span style=color:#75715e>// Redacted
</span><span style=color:#75715e></span>    <span style=color:#f92672>&#34;logger_name&#34;</span>: <span style=color:#e6db74>&#34;app.squaddy.api.persistence.UserPersistenceService&#34;</span>,
    <span style=color:#f92672>&#34;thread_name&#34;</span>: <span style=color:#e6db74>&#34;http-nio-8080-exec-9&#34;</span>,
    <span style=color:#f92672>&#34;level&#34;</span>: <span style=color:#e6db74>&#34;DEBUG&#34;</span>,
    <span style=color:#f92672>&#34;level_value&#34;</span>: <span style=color:#ae81ff>10000</span>,
    <span style=color:#f92672>&#34;transaction.id&#34;</span>: <span style=color:#e6db74>&#34;8b6f99ac-272e-4476-b29c-e0f75cc87bd0&#34;</span>, <span style=color:#75715e>// A unique id for this request
</span><span style=color:#75715e></span>    <span style=color:#f92672>&#34;transaction.requestMethod&#34;</span>: <span style=color:#e6db74>&#34;GET&#34;</span>,
    <span style=color:#f92672>&#34;transaction.requestUrl&#34;</span>: <span style=color:#e6db74>&#34;/v2/user/groups/0&#34;</span>,
    <span style=color:#f92672>&#34;transaction.proxyRemoteIp&#34;</span>: <span style=color:#e6db74>&#34;*****&#34;</span>, <span style=color:#75715e>// Redacted
</span><span style=color:#75715e></span>    <span style=color:#f92672>&#34;transaction.firebaseId&#34;</span>: <span style=color:#e6db74>&#34;**********************&#34;</span>, <span style=color:#75715e>// Redacted
</span><span style=color:#75715e></span>    <span style=color:#f92672>&#34;transaction.host&#34;</span>: <span style=color:#e6db74>&#34;api.squaddy.app&#34;</span>,
    <span style=color:#f92672>&#34;transaction.remoteIp&#34;</span>: <span style=color:#e6db74>&#34;10.0.0.159&#34;</span>,
    <span style=color:#f92672>&#34;transaction.isPublicApi&#34;</span>: <span style=color:#e6db74>&#34;false&#34;</span>,
    <span style=color:#f92672>&#34;transaction.userAgent&#34;</span>: <span style=color:#e6db74>&#34;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/96.0.4664.110 Safari/537.36&#34;</span>,
    <span style=color:#f92672>&#34;tags&#34;</span>: [
        <span style=color:#e6db74>&#34;SECURITY AUDIT&#34;</span> <span style=color:#75715e>// A security marker added
</span><span style=color:#75715e></span>    ]
}
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>By using a security markers and using levels we can restrict the overhead of logging for each environment without altering code.</p>
</blockquote>
<h2 id=encode-your-logs>Encode your logs<a hidden class=anchor aria-hidden=true href=#encode-your-logs>#</a></h2>
<p><a href=https://owasp.org/www-community/attacks/Log_Injection>Log Forging or Log Injection</a> is one of the top OWASP vulnerabilities and not often talked about. The same <a href=https://github.com/javabeanz/owasp-security-logging>owasp-security-logging</a> library can also be configured add <a href=https://github.com/javabeanz/owasp-security-logging/wiki/Log-Forging>CRLF encoding</a> to any logged text.</p>
<p>For example:</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#f92672>&lt;conversionRule</span> <span style=color:#a6e22e>conversionWord=</span><span style=color:#e6db74>&#34;crlf&#34;</span>
                <span style=color:#a6e22e>converterClass=</span><span style=color:#e6db74>&#34;org.owasp.security.logging.mask.CRLFConverter&#34;</span> <span style=color:#f92672>/&gt;</span>

<span style=color:#f92672>&lt;layout</span> <span style=color:#a6e22e>class=</span><span style=color:#e6db74>&#34;ch.qos.logback.classic.PatternLayout&#34;</span><span style=color:#f92672>&gt;</span>
    <span style=color:#f92672>&lt;Pattern&gt;</span>STDOUT %d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %crlf(%msg) %n
    <span style=color:#f92672>&lt;/Pattern&gt;</span>
<span style=color:#f92672>&lt;/layout&gt;</span> 
</code></pre></td></tr></table>
</div>
</div><p>I would also recommend switching to JSON in production over using standard console out as it&rsquo;s a far more flexible (and searchable) format.</p>
<h2 id=add-automated-tooling-to-prevent-security-flaws-before-they-are-merged>Add automated tooling to prevent security flaws before they are merged.<a hidden class=anchor aria-hidden=true href=#add-automated-tooling-to-prevent-security-flaws-before-they-are-merged>#</a></h2>
<p>A final piece in the puzzle is to introduce more automation. There are many options for <a href=https://owasp.org/www-community/controls/Static_Code_Analysis>static code analysis</a> and as usual a mix (and configuration) is required to get a balanced view.</p>
<p>At Squaddy we use <a href=https://sonarcloud.io/>SonarQube&rsquo;s hosted SonarCloud</a> and <a href=https://snyk.io/>Snyk</a>. They both have excellent IntelliJ plugins and integrate well with GitHub Actions.</p>
<p>As mentioned no tool is perfect and SonarQube in particular can sometimes blur the lines between <em>&ldquo;we think this looks better&rdquo;</em>, <em>&ldquo;we believe this to be bad practice&rdquo;</em> and <em>&ldquo;this is a very bad security practice&rdquo;</em>. However on balance they are an absolute upgrade and even if after a bit of research I disagree, I am at least wiser for it.</p>
<h2 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h2>
<p>Thank you for reading and I hope this was useful. My intention was not to deep dive any one subject but more to provide thought on various aspects to security. There is no one size fits all and it doesn&rsquo;t all need to happen in <a href=https://www.bmc.com/blogs/sprint-zero/>Sprint 0</a>.</p>
<p>Ultimately security is an on-going and multi aspect concern. I&rsquo;ve learnt over time that the better you understand your business needs, the easier it is to make security decisions.</p>
</div>
<footer class=post-footer>
<ul class=post-tags>
<li><a href=https://tombeckett.github.io/tags/java/>java</a></li>
<li><a href=https://tombeckett.github.io/tags/spring/>spring</a></li>
<li><a href=https://tombeckett.github.io/tags/spring-boot/>spring-boot</a></li>
<li><a href=https://tombeckett.github.io/tags/security/>security</a></li>
<li><a href=https://tombeckett.github.io/tags/spring-security/>spring-security</a></li>
</ul>
<nav class=paginav>
<a class=prev href=https://tombeckett.github.io/posts/skip-source-read-comments/>
<span class=title>« Prev Page</span>
<br>
<span>Skip the source, straight to the comments</span>
</a>
<a class=next href=https://tombeckett.github.io/posts/spring-magic/>
<span class=title>Next Page »</span>
<br>
<span>Spring Boot: Magic Beans</span>
</a>
</nav>
</footer>
</article>
</main>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
</body>
</html>